<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>课堂监听报警系统 - 控制面板</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>🎓 课堂监听报警系统</h1>
            <p class="subtitle">Classroom Audio Monitor & Alert System</p>
        </header>

        <!-- 状态面板 -->
        <section class="status-panel">
            <div class="status-item">
                <span class="status-label">系统状态</span>
                <span class="status-value" id="systemStatus">
                    <span class="status-dot offline"></span>
                    <span id="statusText">未连接</span>
                </span>
            </div>
            <div class="status-item">
                <span class="status-label">WebSocket</span>
                <span class="status-value" id="wsStatus">ws://localhost:8765</span>
            </div>
            <div class="status-item">
                <span class="status-label">ASR 模式</span>
                <span class="status-value" id="asrMode">-</span>
            </div>
        </section>

        <!-- 实时识别结果 -->
        <section class="card">
            <h2>📝 实时识别结果</h2>
            <!-- 单栏模式（非 Debug） -->
            <div id="singleRecognitionView">
                <div class="recognition-box" id="recognitionBox">
                    <p class="placeholder">等待语音输入...</p>
                </div>
            </div>
            <!-- 双栏模式（Debug） -->
            <div id="debugRecognitionView" class="debug-view" style="display: none;">
                <div class="debug-column">
                    <h4>🎤 ASR 识别</h4>
                    <div class="recognition-box" id="asrRecognitionBox">
                        <p class="placeholder">等待 ASR 识别...</p>
                    </div>
                </div>
                <div class="debug-column">
                    <h4>🤖 Qwen2-Audio</h4>
                    <div class="recognition-box" id="qwen2RecognitionBox">
                        <p class="placeholder">等待 Qwen2-Audio 分析...</p>
                    </div>
                </div>
            </div>
            <!-- LLM 检测状态 -->
            <div id="llmStatus" class="llm-status">
                <span class="time"></span> 等待 LLM 检测...
            </div>
            <!-- 签到码记录 -->
            <div class="code-log" id="codeLog">
                <h3>🔢 签到码记录</h3>
                <div id="codeList" class="code-list">
                    <p class="placeholder">暂未检测到签到码</p>
                </div>
            </div>
            <div class="alert-log" id="alertLog">
                <h3>🔔 报警记录</h3>
                <div id="alertList" class="alert-list">
                    <p class="placeholder">暂无报警记录</p>
                </div>
            </div>
        </section>

        <!-- 配置表单 -->
        <section class="card">
            <h2>⚙️ 系统配置</h2>
            <form id="configForm">
                <!-- 检测模式 -->
                <div class="form-group">
                    <label for="detectMode">检测模式</label>
                    <select id="detectMode" name="detectMode">
                        <option value="asr">ASR + 关键词匹配（传统模式）</option>
                        <option value="asr+llm">ASR + LLM 语义检测（推荐）</option>
                        <option value="qwen2-audio">Qwen2-Audio 大模型（语音理解）</option>
                    </select>
                    <small>ASR+LLM: 每3秒将识别文本发给大模型检测语义意图，兼顾速度和准确性</small>
                </div>

                <!-- Debug 模式 -->
                <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="debugMode" name="debugMode">
                        <span>🔧 调试模式（同时运行 ASR 和 Qwen2-Audio）</span>
                    </label>
                    <small>对比两种模式的识别结果，方便调试</small>
                </div>

                <!-- ASR 配置 -->
                <div class="form-group" id="asrModeGroup">
                    <label for="useCloudApi">ASR 模式</label>
                    <select id="useCloudApi" name="useCloudApi">
                        <option value="true">阿里云 DashScope API (推荐)</option>
                        <option value="false">本地 FunASR</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="apiKey">DashScope API Key</label>
                    <div class="input-with-button">
                        <input type="password" id="apiKey" name="apiKey" placeholder="请输入 API Key">
                        <button type="button" class="btn-small" onclick="toggleApiKeyVisibility()">👁️</button>
                    </div>
                    <small>
                        <a href="https://dashscope.console.aliyun.com/" target="_blank">获取 API Key →</a>
                    </small>
                </div>

                <!-- WebSocket 配置 -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="wsHost">WebSocket 主机</label>
                        <input type="text" id="wsHost" name="wsHost" value="localhost">
                    </div>
                    <div class="form-group">
                        <label for="wsPort">端口</label>
                        <input type="number" id="wsPort" name="wsPort" value="8765">
                    </div>
                </div>

                <!-- 关键词配置 -->
                <div class="form-group">
                    <label for="keywords">监控关键词</label>
                    <textarea id="keywords" name="keywords" rows="3" placeholder="每行一个关键词，或用逗号分隔"></textarea>
                    <small>支持逗号分隔或换行分隔</small>
                </div>

                <!-- 报警配置 -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="cooldown">报警冷却时间 (秒)</label>
                        <input type="number" id="cooldown" name="cooldown" value="5" min="0" max="60">
                        <small>设为 0 表示不限制</small>
                    </div>
                    <div class="form-group">
                        <div class="label-with-status">
                            <label for="customSound">自定义报警音频</label>
                            <span class="current-sound-badge" id="currentSound">🔔 默认蜂鸣声</span>
                        </div>
                        <div class="input-with-button">
                            <input type="text" id="customSound" name="customSound" placeholder="绝对路径或 URL，留空使用默认蜂鸣声">
                            <button type="button" class="btn-small" onclick="validateSound()">验证</button>
                            <button type="button" class="btn-small" onclick="showSoundPicker()"
                                title="选择预设音源">📁</button>
                        </div>
                        <small id="soundValidationResult">支持 wav/mp3/ogg/m4a/flac 格式</small>
                        <div id="soundPicker" class="sound-picker" style="display: none;">
                            <div class="sound-picker-header">
                                <strong>选择音源</strong>
                                <button type="button" class="btn-close" onclick="hideSoundPicker()">×</button>
                            </div>
                            <div id="soundList" class="sound-list">
                                <p class="placeholder">加载中...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 语义匹配配置 -->
                <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="enableSemantic" name="enableSemantic">
                        <span>启用语义模糊匹配</span>
                    </label>
                    <small style="margin-left: 2rem;">使用 AI 语义模型匹配相似表达，如"签个到"≈"签到"（需要 API Key）</small>
                </div>
                <div class="form-row" id="semanticOptions" style="display: none;">
                    <div class="form-group">
                        <label for="semanticThreshold">相似度阈值</label>
                        <input type="range" id="semanticThreshold" name="semanticThreshold" min="0.5" max="0.9"
                            step="0.05" value="0.65">
                        <small>当前值: <span id="thresholdValue">0.65</span>（越高越严格）</small>
                    </div>
                    <div class="form-group">
                        <label for="semanticModel">语义模型</label>
                        <input type="text" id="semanticModel" name="semanticModel"
                            placeholder="text-embedding-v3 或 corom-embedding">
                        <small>可填写阿里 CoROM 模型名称，默认 text-embedding-v3</small>
                    </div>
                </div>

                <!-- 按钮组 -->
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">💾 保存配置</button>
                    <button type="button" class="btn btn-secondary" onclick="loadConfig()">🔄 重新加载</button>
                    <button type="button" class="btn btn-success" onclick="restartService()">🚀 重启服务</button>
                </div>
            </form>
        </section>

        <!-- 使用说明 -->
        <section class="card">
            <h2>📖 使用说明</h2>
            <div class="instructions">
                <ol>
                    <li>在上方配置区域填写 DashScope API Key</li>
                    <li>设置需要监控的关键词（如：签到、点名、扫码等）</li>
                    <li>点击 <strong>保存配置</strong> 保存设置</li>
                    <li>点击 <strong>重启服务</strong> 使配置生效</li>
                    <li>打开 Chrome 浏览器，安装 <code>browser_extension</code> 扩展</li>
                    <li>打开网课页面，点击扩展图标开始捕获音频</li>
                    <li>检测到关键词时会自动播放报警声</li>
                </ol>
            </div>
        </section>

        <footer>
            <p>课堂监听报警系统 v0.7 |
                <a href="https://github.com/wangzhengzhuo05/realtimeBrowserSoundDetector" target="_blank">GitHub</a>
            </p>
        </footer>
    </div>

    <script src="app.js"></script>
</body>

</html>